<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Reference</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>pandoc-zotxt.lua</h1>


<h2>Contents</h2>
<ul>
<li><a href="#Functions">Functions</a></li>
<li><a href="#Tables">Tables</a></li>
<li><a href="#Fields">Fields</a></li>
<li><a href="#Class_DbConnector">Class DbConnector </a></li>
<li><a href="#Class_Zotxt">Class Zotxt </a></li>
<li><a href="#Class_FakeConnector">Class FakeConnector </a></li>
</ul>


<h2>Scripts</h2>
<ul class="nowrap">
  <li><strong>pandoc-zotxt.lua</strong></li>
</ul>
<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/README.md.html">README</a></li>
</ul>

</div>

<div id="content">

<h1>Script <code>pandoc-zotxt.lua</code></h1>
<p>pandoc-zotxt.lua - Looks up citations in Zotero and adds references.</p>
<p> </p>

<p> # SYNOPSIS</p>


<pre>
pandoc <span class="comment">--lua-filter pandoc-zotxt.lua -FÂ pandoc-citeproc</span>
</pre>

<p> # DESCRIPTION</p>

<p> pandoc-zotxt.lua looks up sources of citations in Zotero and adds
 them either to a document's <code>references</code> metadata field or to its
 bibliography, where pandoc-citeproc can pick them up.</p>

<p> You cite your sources using so-called "easy citekeys" (provided by zotxt)
 or "Better BibTeX Citekey Keys" (provided by Better BibTeX for Zotero) and
 then tell pandoc to run pandoc-zotxt.lua before pandoc-citeproc.
 That's all all there is to it. (See the documentation of zotxt and
 Better BibTeX for Zotero respectively for details.)</p>

<p> You can also use pandoc-zotxt.lua to manage a bibliography file. This is
 speeds up subsequent runs of pandoc-zotxt.lua for the same document,
 because pandoc-zotxt.lua will only fetch those sources from Zotero that
 aren't yet in that file. Simply set the <code>zotero-bibliography</code> metadata field
 to a filename. pandoc-zotxt.lua will then add sources to that file, rather
 than to the <code>references</code> metadata field. It will also add that file to the
 document's <code>bibliography</code> metadata field, so that pandoc-citeproc can pick
 them up. The biblography is stored as a JSON file, so the filename must end
 in ".json".</p>

<p> pandoc-zotxt.lua takes relative filenames to be relative to the directory
 of the first input file you pass to pandoc or, if you don't pass any input
 files, as relative to the current working directory.</p>

<p> Note, pandoc-zotxt.lua only ever adds sources to bibliography files.
 It never updates or deletes them. To update your bibliography file,
 delete it. pandoc-zotxt.lua will then regenerate it from scratch.</p>


<p> # KNOWN ISSUES</p>

<p> Zotero v5.0.71 and v5.0.72 fail to handle HTTP requests from user agents
 that  don't set the "User Agent" HTTP header. And pandoc doesn't. As a
 consequence, pandoc-zotxt.lua cannot retrieve data from these versions of
 Zotero unless you tell pandoc to set the "User Agent" HTTP header.</p>

<p> If you cannot (or rather would not) upgrade to a more recent version of
 Zotero, you can make pandoc set that header, thereby enabling
 pandoc-zotxt.lua to connect to your version of Zotero, by passing
 "--request-header User-Agent:Pandoc/2".</p>

<p> Note, from Zotero v5.0.71 onwards, Zotero doesn't allow browsers to access
 its interface. It defines "browser" as any user agent that sets the "User
 Agent" HTTP header to a string that starts with "Mozilla/". So, for
 instance, "--request-header User-Agent:Mozilla/5" will not enable
 pandoc-zotxt.lua to connect. If you must set the "User Agent" HTTP header to
 a string that starts with "Mozilla/", you also have set the HTTP header
 "Zotero-Allowed-Request". You can do so by "--request-header
 Zotero-Allowed-Request:X".</p>


<p> # CAVEATS</p>

<p> pandoc-zotxt.lua is partly Unicode-agnostic.</p>


<p> # SEE ALSO</p>

<p> pandoc(1), pandoc-citeproc(1)</p>


<p> # AUTHOR</p>

<p> Copyright 2019 Odin Kroeger</p>


<p> # LICENSE</p>

<p> Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to
 deal in the Software without restriction, including without limitation the
 rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 sell copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:</p>

<p> The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.</p>

<p> THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 IN THE SOFTWARE.</p>
    <h3>Info:</h3>
    <ul>
        <li><strong>Copyright</strong>: 2018, 2019 Odin Kroeger</li>
        <li><strong>Release</strong>: 0.3.18b</li>
        <li><strong>License</strong>: MIT</li>
        <li><strong>Author</strong>: Odin Kroeger</li>
    </ul>


<h2><a href="#Functions">Functions</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#split_path">split_path (path)</a></td>
	<td class="summary">Splits a file's path into a directory and a filename part.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#Pandoc">Pandoc (doc)</a></td>
	<td class="summary">Collects sources and adds bibliographic data to document.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#get_citekeys">get_citekeys (doc)</a></td>
	<td class="summary">Collects the citation keys occurring in a document.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#add_sources">add_sources (db, citekeys, meta)</a></td>
	<td class="summary">Adds sources to document's metadata or its bibliography.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#add_references">add_references (db, citekeys, meta)</a></td>
	<td class="summary">Adds sources to metadata block of a document.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#add_bibliography">add_bibliography (db, citekeys, meta)</a></td>
	<td class="summary">Adds sources to bibliography and the bibliography to document's metadata.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#update_bibliography">update_bibliography (db, citekeys, fname)</a></td>
	<td class="summary">Adds cited sources to a bibliography file.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#get_db_connector">get_db_connector (name)</a></td>
	<td class="summary">Look up a database connector by its name.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#read_json_file">read_json_file (fname)</a></td>
	<td class="summary">Reads a JSON file.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#write_json_file">write_json_file (data, fname)</a></td>
	<td class="summary">Writes data to a file in JSON.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#delegates_to">delegates_to (tbl, proto)</a></td>
	<td class="summary">Checks whether an object delegates to a particular prototype.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#convert_numbers_to_strings">convert_numbers_to_strings (data)</a></td>
	<td class="summary">Converts all numbers in a multi-dimensional table to strings.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#convert_meta_to_table">convert_meta_to_table (meta)</a></td>
	<td class="summary">Converts a document's metadata block to a table.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#is_path_absolute">is_path_absolute (path)</a></td>
	<td class="summary">Checks if a path is absolute.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#get_input_directory">get_input_directory ()</a></td>
	<td class="summary">Returns the directory of the first input file or '.'.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#get_position">get_position (elem, list)</a></td>
	<td class="summary">Returns the position of an element in a list.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#map">map (func, list)</a></td>
	<td class="summary">Applies a function to every element of a list.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#warn">warn (...)</a></td>
	<td class="summary">Prints warnings to STDERR.</td>
	</tr>
</table>
<h2><a href="#Tables">Tables</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#ZOTXT_KEYTYPES">ZOTXT_KEYTYPES</a></td>
	<td class="summary">Types of zotxt citation keys.</td>
	</tr>
</table>
<h2><a href="#Fields">Fields</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#PATH_SEP">PATH_SEP</a></td>
	<td class="summary">The path seperator of the operating system.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#SCRIPT_DIR">SCRIPT_DIR</a></td>
	<td class="summary">The directory this script resides in.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#SCRIPT_NAME">SCRIPT_NAME</a></td>
	<td class="summary">The name of this script.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#SCRIPT_VERSION">SCRIPT_VERSION</a></td>
	<td class="summary">The version of this script.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#DEFAULT_CONNECTOR">DEFAULT_CONNECTOR</a></td>
	<td class="summary">Name of the database connector to use by default.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#ZOTXT_BASE_URL">ZOTXT_BASE_URL</a></td>
	<td class="summary"><a href="https://www.lua.org/manual/5.3/manual.html#pdf-string.format">string.format</a> format to generate zotxt query URLs.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#EOL">EOL</a></td>
	<td class="summary">The character sequence of the operating system to end a line.</td>
	</tr>
</table>
<h2><a href="#Class_DbConnector">Class DbConnector </a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#DbConnector:read_url">DbConnector:read_url (url)</a></td>
	<td class="summary">Reads data from a URL.</td>
	</tr>
</table>
<h2><a href="#Class_Zotxt">Class Zotxt </a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#Zotxt:new">Zotxt:new ()</a></td>
	<td class="summary">Creates an connector instance to retrieve data from zotxt.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#Zotxt:get_source">Zotxt:get_source (citekey)</a></td>
	<td class="summary">Retrieves bibliographic data for a source from zotxt.</td>
	</tr>
</table>
<h2><a href="#Class_FakeConnector">Class FakeConnector </a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#FakeConnector:new">FakeConnector:new (args)</a></td>
	<td class="summary">Creates an instance that establishes a fake connection.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#FakeConnector:read_url">FakeConnector:read_url (url)</a></td>
	<td class="summary">Returns canned responses for URL requests.</td>
	</tr>
</table>

<br/>
<br/>


    <h2 class="section-header "><a name="Functions"></a>Functions</h2>

    <dl class="function">
    <dt>
    <a name = "split_path"></a>
    <strong>split_path (path)</strong>
    </dt>
    <dd>
    Splits a file's path into a directory and a filename part. </p>

<p> Makes an educated guess on the basis of the given path.
 It doesn't look at the filesystem.
 (The guess is educated enough though.)


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">path</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         The path to the file.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        The file's path.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        The file's name.</li>
    </ol>

    <h3>Raises:</h3>
    An error if <code>path</code> is the empty string.



</dd>
    <dt>
    <a name = "Pandoc"></a>
    <strong>Pandoc (doc)</strong>
    </dt>
    <dd>
    Collects sources and adds bibliographic data to document. </p>

<p> Prints messages to STDERR if errors occur.</p>

<p> See the manual page for detais.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">doc</span>
            <span class="types"><span class="type">pandoc.Pandoc</span></span>
         A document.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">pandoc.Pandoc</span></span>
        <code>doc</code>, but with bibliographic data added.
    </ol>
     <h3>Or</h3>
    <ol>

           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if nothing was done or an error occurred.
    </ol>

    <h3>Raises:</h3>
    An uncatchable error if it cannot retrieve any data.



</dd>
    <dt>
    <a name = "get_citekeys"></a>
    <strong>get_citekeys (doc)</strong>
    </dt>
    <dd>
    Collects the citation keys occurring in a document.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">doc</span>
            <span class="types"><span class="type">pandoc.Doc</span></span>
         A document.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">{str,...}</span></span>
        A list of citation keys.
    </ol>




</dd>
    <dt>
    <a name = "add_sources"></a>
    <strong>add_sources (db, citekeys, meta)</strong>
    </dt>
    <dd>
    Adds sources to document's metadata or its bibliography. </p>

<p> Checks whether the given document uses a bibliography. If so, adds
 sources that aren't in it yet. Otherwise, adds all cited sources
 to the given metadata block.</p>

<p> Prints messages to STDERR if errors occur.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">db</span>
            <span class="types"><a class="type" href="../index.html#DbConnector">DbConnector</a></span>
         A connection to a reference manager.
        </li>
        <li><span class="parameter">citekeys</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">{string,...}</a></span>
         The citation keys of the sources to add.
        </li>
        <li><span class="parameter">meta</span>
            <span class="types"><span class="type">pandoc.Meta</span></span>
         A metadata block.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">pandoc.Meta</span></span>
        An updated metadata block, with references or
  a pointer to the bibliography file
    </ol>
     <h3>Or</h3>
    <ol>

           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if nothing was done or an error occurred.
    </ol>

    <h3>Raises:</h3>
    An uncatchable error if it cannot retrieve any data.



</dd>
    <dt>
    <a name = "add_references"></a>
    <strong>add_references (db, citekeys, meta)</strong>
    </dt>
    <dd>
    Adds sources to metadata block of a document. </p>

<p> Prints an error message to STDERR for every source that cannot be found.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">db</span>
            <span class="types"><a class="type" href="../index.html#DbConnector">DbConnector</a></span>
         A connection to a reference manager.
        </li>
        <li><span class="parameter">citekeys</span>
            <span class="types"><span class="type">{str,...}</span></span>
         The citation keys of the sources to add.
        </li>
        <li><span class="parameter">meta</span>
            <span class="types"><span class="type">pandoc.Meta</span></span>
         A metadata block.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">pandoc.Meta</span></span>
        An updated metadata block, with the field
  <code>references</code> added if needed.
    </ol>
     <h3>Or</h3>
    <ol>

           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if no sources were found.
    </ol>

    <h3>Raises:</h3>
    An uncatchable error if it cannot retrieve any data.



</dd>
    <dt>
    <a name = "add_bibliography"></a>
    <strong>add_bibliography (db, citekeys, meta)</strong>
    </dt>
    <dd>
    Adds sources to bibliography and the bibliography to document's metadata. </p>

<p> Prints an error message to STDERR for every source that cannot be found.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">db</span>
            <span class="types"><a class="type" href="../index.html#DbConnector">DbConnector</a></span>
         A connection to a reference manager.
        </li>
        <li><span class="parameter">citekeys</span>
            <span class="types"><span class="type">{str,...}</span></span>
         The citation keys of the sources to add.
        </li>
        <li><span class="parameter">meta</span>
            <span class="types"><span class="type">pandoc.Meta</span></span>
         A metadata block.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">pandoc.Meta</span></span>
        An updated metadata block, with the field
  <code>bibliography</code> added if needed.
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if no sources were found,
  <code>zotero-bibliography</code> is not set, or an error occurred.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message, if applicable.</li>
    </ol>

    <h3>Raises:</h3>
    May raise an uncatchable error if <code>zotero-bibliography</code> isn't a string.



</dd>
    <dt>
    <a name = "update_bibliography"></a>
    <strong>update_bibliography (db, citekeys, fname)</strong>
    </dt>
    <dd>
    Adds cited sources to a bibliography file. </p>

<p> Prints an error message to STDERR for every source that cannot be found.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">db</span>
            <span class="types"><a class="type" href="../index.html#DbConnector">DbConnector</a></span>
         A connection to a reference manager.
        </li>
        <li><span class="parameter">citekeys</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">{string,...}</a></span>
         The citation keys of the sources to add,
  e.g., 'name:2019word', 'name2019WordWordWord'.
        </li>
        <li><span class="parameter">fname</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         The filename of the bibliography.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">bool</span></span>
        <code>true</code> if the bibliography file was updated
  or no update was needed.
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if an error occurrs.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message.</li>
    </ol>

    <h3>Raises:</h3>
     An uncatchable error if it cannot retrieve any data and
  a catchable error if <code>fname</code> is not a string, <code>citekeys</code> is not a table,
  <code>fname</code> is the empty string.




</dd>
    <dt>
    <a name = "get_db_connector"></a>
    <strong>get_db_connector (name)</strong>
    </dt>
    <dd>
    Look up a database connector by its name.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">name</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         The name of a database connector.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../index.html#DbConnector">DbConnector</a></span>
        A connector.
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if an error occurred.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message.</li>
    </ol>

    <h3>Raises:</h3>
    An error if <code>name</code> is not a <a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a>.



</dd>
    <dt>
    <a name = "read_json_file"></a>
    <strong>read_json_file (fname)</strong>
    </dt>
    <dd>
    Reads a JSON file.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">fname</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         Name of the file.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        The parsed data
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if an error occurred.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message.</li>
        <li>
           <span class="types"><span class="type">number</span></span>
        An error number. Positive numbers are OS error numbers,
  negative numbers indicate a JSON decoding error.</li>
    </ol>

    <h3>Raises:</h3>
    An error if <code>fname</code> is not a <a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a> or the empty string.



</dd>
    <dt>
    <a name = "write_json_file"></a>
    <strong>write_json_file (data, fname)</strong>
    </dt>
    <dd>
    Writes data to a file in JSON.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">data</span>
         Data.
        </li>
        <li><span class="parameter">fname</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         Name of the file.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">bool</span></span>
        <code>true</code> if the data was written to the file.
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if an error occurred.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message.</li>
        <li>
           <span class="types"><span class="type">number</span></span>
        An error number. Positive numbers are OS error numbers,
  negative numbers indicate a JSON encoding error.</li>
    </ol>

    <h3>Raises:</h3>
    An error if <code>fname</code> is not a <a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a> or the empty string.



</dd>
    <dt>
    <a name = "delegates_to"></a>
    <strong>delegates_to (tbl, proto)</strong>
    </dt>
    <dd>
    Checks whether an object delegates to a particular prototype. </p>

<p> Assumes:
 (1) <code>tbl</code> uses metatables to implement prototype inheritance.
 (2) <code>__metatable</code> isn't set for <code>tbl</code> or any of its prototypes.
 (3) <a href="https://www.lua.org/manual/5.3/manual.html#pdf-getmetatable">getmetatable</a> is available.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a></span>
         The table.
        </li>
        <li><span class="parameter">proto</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a></span>
         The prototype.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">bool</span></span>
        Whether the table is delegates to the prototype.
    </ol>

    <h3>Raises:</h3>
    An error if the number of nested calls exceeds 512.



</dd>
    <dt>
    <a name = "convert_numbers_to_strings"></a>
    <strong>convert_numbers_to_strings (data)</strong>
    </dt>
    <dd>
    Converts all numbers in a multi-dimensional table to strings. </p>

<p> Also converts floating point numbers to integers. This is needed
 because all numbers are floating point numbers in JSON, but older
 versions of Pandoc expect integers.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">data</span>
         Data.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        The given data, with all numbers converted into strings.
    </ol>

    <h3>Raises:</h3>
    An error if the number of nested calls exceeds 512.



</dd>
    <dt>
    <a name = "convert_meta_to_table"></a>
    <strong>convert_meta_to_table (meta)</strong>
    </dt>
    <dd>
    Converts a document's metadata block to a table. </p>

<p> Converts Pandoc's metadata types to Lua data types in the process.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">meta</span>
            <span class="types"><span class="type">pandoc.Meta</span></span>
         The document's metadata.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">tab</span></span>
        The metadata as table.
    </ol>

    <h3>Raises:</h3>
    An error if the number of nested calls exceeds 512.



</dd>
    <dt>
    <a name = "is_path_absolute"></a>
    <strong>is_path_absolute (path)</strong>
    </dt>
    <dd>
    Checks if a path is absolute.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">path</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         A path.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">bool</span></span>
        <code>true</code> if the path is absolute, <code>false</code> otherwise.
    </ol>




</dd>
    <dt>
    <a name = "get_input_directory"></a>
    <strong>get_input_directory ()</strong>
    </dt>
    <dd>
    Returns the directory of the first input file or '.'.



    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        The directory of the first input file.
    </ol>
     <h3>Or</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        '.' if no input files were given.
    </ol>




</dd>
    <dt>
    <a name = "get_position"></a>
    <strong>get_position (elem, list)</strong>
    </dt>
    <dd>
    Returns the position of an element in a list.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">elem</span>
         The element.
        </li>
        <li><span class="parameter">list</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a></span>
         The list.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><span class="type">integer</span></span>
        The index of the element.
    </ol>
     <h3>Or</h3>
    <ol>

           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if the list doesn't contain the element.
    </ol>




</dd>
    <dt>
    <a name = "map"></a>
    <strong>map (func, list)</strong>
    </dt>
    <dd>
    Applies a function to every element of a list.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">func</span>
            <span class="types"><span class="type">func</span></span>
         The function.
        </li>
        <li><span class="parameter">list</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a></span>
         The list.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a></span>
        The return values of <code>f</code>.
    </ol>




</dd>
    <dt>
    <a name = "warn"></a>
    <strong>warn (...)</strong>
    </dt>
    <dd>
    Prints warnings to STDERR. </p>

<p> Prefixes every line with the global <a href="../index.html#SCRIPT_NAME">SCRIPT_NAME</a> and ": ".
 Also appends an end of line sequence if needed.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">...</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         Strings to be written to STDERR.
        </li>
    </ul>





</dd>
</dl>
    <h2 class="section-header "><a name="Tables"></a>Tables</h2>

    <dl class="function">
    <dt>
    <a name = "ZOTXT_KEYTYPES"></a>
    <strong>ZOTXT_KEYTYPES</strong>
    </dt>
    <dd>
    Types of zotxt citation keys.


    <h3>Fields:</h3>
    <ul>
        <li><span class="parameter">easykey</span>
        zotxt easy citekey
        </li>
        <li><span class="parameter">betterbibtexkey</span>
        Better BibTeX citation key
        </li>
        <li><span class="parameter">key</span>
        Zotero item ID
        </li>
    </ul>



    <h3>See also:</h3>
    <ul>
         <a href="../index.html#Zotxt">Zotxt</a>
    </ul>


</dd>
</dl>
    <h2 class="section-header "><a name="Fields"></a>Fields</h2>

    <dl class="function">
    <dt>
    <a name = "PATH_SEP"></a>
    <strong>PATH_SEP</strong>
    </dt>
    <dd>
    The path seperator of the operating system.







</dd>
    <dt>
    <a name = "SCRIPT_DIR"></a>
    <strong>SCRIPT_DIR</strong>
    </dt>
    <dd>
    The directory this script resides in.







</dd>
    <dt>
    <a name = "SCRIPT_NAME"></a>
    <strong>SCRIPT_NAME</strong>
    </dt>
    <dd>
    The name of this script.







</dd>
    <dt>
    <a name = "SCRIPT_VERSION"></a>
    <strong>SCRIPT_VERSION</strong>
    </dt>
    <dd>
    The version of this script.







</dd>
    <dt>
    <a name = "DEFAULT_CONNECTOR"></a>
    <strong>DEFAULT_CONNECTOR</strong>
    </dt>
    <dd>
    Name of the database connector to use by default.







</dd>
    <dt>
    <a name = "ZOTXT_BASE_URL"></a>
    <strong>ZOTXT_BASE_URL</strong>
    </dt>
    <dd>
    <a href="https://www.lua.org/manual/5.3/manual.html#pdf-string.format">string.format</a> format to generate zotxt query URLs.  </p>

<p> <code>Zotxt.get_source</code> replaces:
 the first '%s' with the citation key type (e.g., 'easykey'),
 the second '%s' with the citation key (e.g., 'doe:2000word').





    <h3>See also:</h3>
    <ul>
         <a href="../index.html#Zotxt">Zotxt</a>
    </ul>


</dd>
    <dt>
    <a name = "EOL"></a>
    <strong>EOL</strong>
    </dt>
    <dd>
    The character sequence of the operating system to end a line.







</dd>
</dl>
    <h2 class="section-header has-description"><a name="Class_DbConnector"></a>Class DbConnector </h2>

          <div class="section-description">
          Base prototype for database connections. </p>

<p> <a href="../index.html#">pandoc-zotxt.lua</a> could, in principle, retrieve bibliographic data from
 different reference managers. (It just so happens that it currently only
 supports Zotero via zotxt.) </p>

<p> You can add support for other reference manangers (or other ways of
 retrieving data from Zotero) by adding prototypes that implement the</p>

<p> # DATABASE CONNECTOR PROTOCOL</p>

<p> A database connector implements:</p>

<p> ## Method <a href="../index.html#FakeConnector:new">new</a> (required)</p>

<p> Arguments:</p>

<p>  Settings (as <a href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a> of key-value pairs)
  Document metadata (as <code>pandoc.Meta</code>)</p>

<p> Returns:</p>

<p> A database connection. The connection must delegate to <code>DbConncetor</code>.</p>

<p> On error:</p>

<p> Throw an error.</p>

<p> ## Method <a href="../index.html#Zotxt:get_source">get_source</a> (required)</p>

<p> Arguments:</p>

<p>  Citation key (as <a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a>)</p>

<p> Returns:</p>

<p> A bibliographic item in CSL format (as <a href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a>).</p>

<p> On error:</p>

<p> Return <code>nil</code> and an error message.</p>

<p> Behaviour:</p>

<p> If <a href="../index.html#Zotxt:get_source">get_source</a> retrieves data via HTTP GET requests it should do so
 by calling <code>self:read_url</code>. <a href="../index.html#DbConnector">DbConnector</a> implements a <a href="../index.html#FakeConnector:read_url">read_url</a> method,
 so this will call <a href="../index.html#DbConnector:read_url">DbConnector:read_url</a>. This allows to test a database
 connector using <a href="../index.html#FakeConnector">FakeConnector</a>.</p>

<p> ## Method <code>add_settings</code> (optional)</p>

<p> Arguments:</p>

<p> A list of setting definitions (as <code>Settings</code>)</p>

<p> Behaviour:</p>

<p> Should add any settings for the database connector. <a href="../index.html#Pandoc">Pandoc</a> will then
 look for those settings in the document's metadata and pass them to
 <a href="../index.html#FakeConnector:new">new</a>.
          </div>
    <dl class="function">
    <dt>
    <a name = "DbConnector:read_url"></a>
    <strong>DbConnector:read_url (url)</strong>
    </dt>
    <dd>
    Reads data from a URL.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">url</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         The URL.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        The data.
    </ol>

    <h3>Raises:</h3>
    An uncatchable error if it cannot retrieve any data.



</dd>
</dl>
    <h2 class="section-header has-description"><a name="Class_Zotxt"></a>Class Zotxt </h2>

          <div class="section-description">
          Connect to local Zotero database using zotxt.
          </div>
    <dl class="function">
    <dt>
    <a name = "Zotxt:new"></a>
    <strong>Zotxt:new ()</strong>
    </dt>
    <dd>
    Creates an connector instance to retrieve data from zotxt.



    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../index.html#Zotxt">Zotxt</a></span>
        The instance.
    </ol>




</dd>
    <dt>
    <a name = "Zotxt:get_source"></a>
    <strong>Zotxt:get_source (citekey)</strong>
    </dt>
    <dd>
    Retrieves bibliographic data for a source from zotxt. </p>

<p> Tries different types of citation keys, starting with the last one
 that a lookup was successful for.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">citekey</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         The citation key of the source,
  e.g., 'name:2019word', 'name2019TwoWords'.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.6">table</a></span>
        A CSL item.
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if the source wasn't found or an error occurred.</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message.</li>
    </ol>

    <h3>Raises:</h3>
    An uncatchable error if it cannot retrieve any data and
  a catchable error if <code>citekey</code> is not a <a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a>.



</dd>
</dl>
    <h2 class="section-header has-description"><a name="Class_FakeConnector"></a>Class FakeConnector </h2>

          <div class="section-description">
          Fake connections for testing. </p>

<p> Takes any database connector that connects to a reference manager via HTTP
 GET requests and fakes connection to that reference manager by re-routing
 those requests to the filesystem. This only works for database connectors
 that use <code>self:read_url</code> to make HTTP GET requests.
          </div>
    <dl class="function">
    <dt>
    <a name = "FakeConnector:new"></a>
    <strong>FakeConnector:new (args)</strong>
    </dt>
    <dd>
    Creates an instance that establishes a fake connection. </p>

<p> Takes the same arguments as the database connectors it 'fakes' plus:


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">args</span>
            <span class="types"><span class="type">tab</span></span>



<ul>
    <li><code>fake-db-connector</code>: (<a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a>)
    The name of the database connector to 'fake'.</li>
    <li><code>fake-data-dir</code>: (<a href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a>)
    The directory to look up files in.</li>
</ul>


        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="../index.html#FakeConnector">FakeConnector</a></span>
        The 'connection'.
    </ol>
     <h3>Or</h3>
    <ol>
        <li>
           <span class="types"><span class="type">nil</span></span>
        <code>nil</code> if an error occurres</li>
        <li>
           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message.</li>
    </ol>




</dd>
    <dt>
    <a name = "FakeConnector:read_url"></a>
    <strong>FakeConnector:read_url (url)</strong>
    </dt>
    <dd>
    Returns canned responses for URL requests. </p>

<p> Takes the given URL, hashes it using SHA-1, truncates the hash to eight
 characters and then returns the content of the file of that name
 (in the directory passed to <a href="../index.html#FakeConnector:new">FakeConnector:new</a> via <code>fake-data-dir</code>.)</p>

<p> Prints the requested URL and the file it serves to STDERR.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">url</span>
            <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
         The URL.
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        The data.
    </ol>
     <h3>Or</h3>
    <ol>

           <span class="types"><a class="type" href="https://www.lua.org/manual/5.3/manual.html#6.4">string</a></span>
        An error message (<em>not</em> <code>nil</code>) if an error occurred.
    </ol>




</dd>
</dl>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2019-10-12 19:29:30 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
